<div class="game-page">
  <header class="topbar">
    <app-back-button ariaLabel="Volver" [iconOnly]="true"></app-back-button>
    <h2 class="title">{{ pageTitle }}</h2>
    <div class="actions" *ngIf="isPlanned() && !hasLocation()">
      <button class="primary" (click)="toggleAvailabilityPanel()">Ver disponibilidad del rival</button>
    </div>
  </header>

  <section class="hero" *ngIf="game">
    <img [src]="game.sport_name === 'tennis' ? 'assets/images/sports/tennis/tennis-field-1.jpeg' : (game.sport_name === 'padel' ? 'assets/images/sports/padel/padel-field-1.jpeg' : 'assets/images/default-field.jpg')" alt="Imagen deporte" />
    <div class="overlay">
      <div class="teams">{{ game.team1?.name }} vs {{ game.team2?.name }}</div>
      <div class="meta">
        <span>{{ game.date | date: 'EEE d MMM ¬∑ HH:mm' }}</span>
        <span>üìç {{ game.location || '-' }}</span>
        <span>Nivel: {{ game.level || '-' }}</span>
      </div>
    </div>
  </section>

  <section class="details" *ngIf="game">
    <div class="detail-row">
      <span class="label">ID</span>
      <span class="value">{{ game.id }}</span>
    </div>
    <div class="detail-row">
      <span class="label">Deporte</span>
      <span class="value">{{ game.sport_name || '-' }}</span>
    </div>
    <div class="detail-row">
      <span class="label">Tipo</span>
      <span class="value">{{ game.type ?? '-' }}</span>
    </div>
    <div class="detail-row" *ngIf="game">
      <span class="label">Equipo 1</span>
      <span class="value">{{ game.team1?.name || '-' }}</span>
    </div>
    <div class="detail-row" *ngIf="game">
      <span class="label">Equipo 2</span>
      <span class="value">{{ game.team2?.name || '-' }}</span>
    </div>
    <div class="detail-row">
      <span class="label">Ubicaci√≥n</span>
      <span class="value">{{ game.location || '-' }}</span>
    </div>
    <div class="detail-row" *ngIf="game.result">
      <span class="label">Resultado</span>
      <span class="value">{{ game.result }}</span>
    </div>
    <div class="detail-row" *ngIf="game.team1?.captain_phone">
      <span class="label">Tel√©fono capit√°n (Equipo 1)</span>
      <span class="value">{{ game.team1?.captain_phone }}</span>
    </div>
    <div class="detail-row" *ngIf="game.team2?.captain_phone">
      <span class="label">Tel√©fono capit√°n (Equipo 2)</span>
      <span class="value">{{ game.team2?.captain_phone }}</span>
    </div>
  </section>

  <div class="actions" *ngIf="isPlanned() && !hasLocation()">
    <button class="primary" (click)="toggleAvailabilityPanel()">Ver coincidencias de disponibilidad de ambos equipos</button>
  </div>
  <section *ngIf="showPlanning()" class="card planning">
    <h3>Planificar partido</h3>
    <p class="info">Este apartado es informativo para revisar la disponibilidad del rival. Selecciona un d√≠a y franja para ver su horario habitual. La reserva de pista se gestiona fuera de la app.</p>
    <div class="days scroller-x">
      <button
        *ngFor="let day of availability()"
        [disabled]="!day.enabled"
        [class.active]="day.key === selectedDayKey()"
        (click)="selectDay(day)">
        {{ day.label }}
      </button>
    </div>
    <div class="slots">
      <label class="slot">
        <input type="radio" name="slot" (change)="pickTime('morning')">
        Ma√±ana: {{ selectedMorningStart }} - {{ selectedMorningEnd }}
      </label>
      <label class="slot">
        <input type="radio" name="slot" (change)="pickTime('afternoon')">
        Tarde: {{ selectedAfternoonStart }} - {{ selectedAfternoonEnd }}
      </label>
    </div>
  </section>

  <section *ngIf="showReservation()" class="card reservation">
    <h3>Enviar reserva al rival</h3>
    <div class="form-grid">
      <label>
        Centro
        <select [ngModel]="selectedCenterId" (ngModelChange)="onCenterChange($event)">
          <option [ngValue]="null">Selecciona centro</option>
          <option *ngFor="let c of centers" [ngValue]="c.id">{{ c.name }}</option>
        </select>
      </label>

      <label>
        Pista
        <select [disabled]="!selectedCenterId" [ngModel]="selectedCourt" (ngModelChange)="selectedCourt = $event">
          <option [ngValue]="null">Selecciona pista</option>
          <option *ngFor="let p of (selectedCenterId ? courtsByCenter[selectedCenterId] : [])" [ngValue]="p">{{ p }}</option>
        </select>
      </label>

      <label>
        D√≠a
        <input type="date" [ngModel]="selectedReservationDate" (ngModelChange)="onReservationDateChange($event)" />
      </label>

      <label>
        Hora
        <input type="time" [ngModel]="selectedReservationTime" (ngModelChange)="onReservationTimeChange($event)" />
      </label>
    </div>

    <button class="primary" (click)="sendReservationToRival()">Enviar propuesta</button>
    <p class="hint">La reserva real se realiza fuera de la app. Usa este env√≠o para acordar con el rival.</p>
  </section>

  <section *ngIf="showResultEntry()" class="card result">
    <h3>Introducir resultado</h3>

    <div *ngIf="sportKey === 'padel' || sportKey === 'tennis'" class="sets">
      <label class="bestof">
        Mejor de:
        <select [ngModel]="bestOf()" (ngModelChange)="onBestOfChange($event)">
          <option [ngValue]="3">3 sets</option>
          <option [ngValue]="5">5 sets</option>
        </select>
      </label>

      <div class="set-row" *ngFor="let s of setScores(); let i = index">
        <span class="set-label">Set {{ i + 1 }}</span>
        <input class="score" type="number" min="0" max="7" placeholder="Equipo 1" [(ngModel)]="setScores()[i].team1">
        <input class="score" type="number" min="0" max="7" placeholder="Equipo 2" [(ngModel)]="setScores()[i].team2">
      </div>

      <button class="primary" (click)="saveResult()">Guardar y enviar validaci√≥n al rival</button>
    </div>

    <div *ngIf="sportKey !== 'padel' && sportKey !== 'tennis'" class="not-implemented">
      Formato de resultado no implementado para este deporte.
    </div>
  </section>

  <section *ngIf="showResultInfo()" class="card result readonly">
    <h3>Resultado</h3>
    <p class="info">Partido completado. El resultado est√° confirmado y no se puede modificar.</p>
    <div class="result-view">
      <strong>{{ game?.result || '-' }}</strong>
    </div>
  </section>
</div>
